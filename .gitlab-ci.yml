stages:
  - test
  - build

variables:
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: "/certs"
  NODE_VERSION: "22"

services:
  - docker:20.10.16-dind

# Build jobs that run only on merge requests
build-server:
  stage: test
  image: node:$NODE_VERSION
  cache:
    key: 
      files:
        - server/package-lock.json
        - shared/package-lock.json
    paths:
      - server/node_modules/
      - shared/node_modules/
  before_script:
    - cd shared && npm ci
    - cd ../server && npm ci --ignore-scripts
  script:
    - npm run build
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"

build-client:
  stage: test
  image: node:$NODE_VERSION
  cache:
    key:
      files:
        - client/package-lock.json
        - shared/package-lock.json
    paths:
      - client/node_modules/
      - shared/node_modules/
  before_script:
    - cd shared && npm ci
    - cd ../client && npm ci --ignore-scripts
  script:
    - npm run build
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"

# Docker build jobs that run only on main/dev branches
docker-build-server:
  stage: build
  image: docker:25.0.5
  services:
    - docker:25.0.5-dind
  needs:
    - test
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - docker build -f server/Dockerfile -t $CI_REGISTRY_IMAGE/server-$CI_COMMIT_REF_NAME:$CI_COMMIT_SHA -t $CI_REGISTRY_IMAGE/server-$CI_COMMIT_REF_NAME:latest .
    - docker push $CI_REGISTRY_IMAGE/server-$CI_COMMIT_REF_NAME:$CI_COMMIT_SHA
    - docker push $CI_REGISTRY_IMAGE/server-$CI_COMMIT_REF_NAME:latest
  only:
    - main
    - dev

docker-build-client:
  stage: build
  image: docker:25.0.5
  services:
    - docker:25.0.5-dind
  needs:
    - test
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - docker build -f client/Dockerfile -t $CI_REGISTRY_IMAGE/client-$CI_COMMIT_REF_NAME:$CI_COMMIT_SHA -t $CI_REGISTRY_IMAGE/client-$CI_COMMIT_REF_NAME:latest .
    - docker push $CI_REGISTRY_IMAGE/client-$CI_COMMIT_REF_NAME:$CI_COMMIT_SHA
    - docker push $CI_REGISTRY_IMAGE/client-$CI_COMMIT_REF_NAME:latest
  only:
    - main
    - dev